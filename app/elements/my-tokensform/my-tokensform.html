<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<dom-module id="my-tokensform">
    <template>
        <style is="custom-style" include="iron-flex">
            :host {
                display: inline-block;
                overflow: auto;
                box-sizing: border-box;
                padding-block-end: 1px;
            }

            p {
                margin: 0;
            }

            .contenedor {
                width: 100%;
                height: 100%;
            }

            .text {
                padding: 0px 26px;
                text-align: left;
                min-width: 150px;

            }

            .custom:hover {
                background-color: white;
                color: #001f3f;
            }

            .defect {
                text-align: center;
                font-size: 30px;
                padding-top: 135px;
                line-height: 45px;
            }

            .atributos {
                margin: 4px 0;
            }

            .custom {
                /* background-color: #5c6bc0; */
                background-color: #001f3f;
                color: white;
                align-self: center;
                margin-top: 3px;
                margin-bottom: 9px;
            }

            .encabezado {
                text-align: center;
                font-size: 25px;
                padding: 9px 26px;              
            }
            .encabezado1 {
                font-size: 25px;
                padding: 0px 26px;
            }
        </style>
        <div class="contenedor vertical layout">
            <template is="dom-if" if="{{visible}}">
                <p class="encabezado"  name$="{{data.name}}">Introduce los atributos necesarios del componente {{getName}}</p>
            </template>
            <template is="dom-if" if="{{!visible}}">
                <p class="defect">No se ha elegido aún ningun componente, seleccione uno de los del catálogo o suba uno para calcular su calidad</p>
            </template>
            <template is="dom-if" if="{{visible}}">
                <div id="input-container" class="vertical layout">
                    <!-- <span id="name" name$="{{data.name}}">Componente {{getName}}</span><br> -->
                    <span class="encabezado1">Atributos</span>
                    <template id="bucle_attr" is="dom-repeat" items="{{getAttr}}">
                        <div class="atributos horizontal layout center">
                            <label class="text" for="text">{{item.name}}</label>
                            <input id="caja" class="flex" type="text" on-change="_newChanges" />
                        </div>
                    </template>
                </div>
                <paper-button raised class="custom indigo" id="button_analize" on-click="_analize">
                    Enviar y analizar
                </paper-button>
            </template>
        </div>

        <iron-ajax id="send_attr" method="post" url="/api/componentes" handle-as="json" on-response="handleResponse" body='{{_getParams(getName, prop_object)}}'
            content-type="application/json"></iron-ajax>
    </template>
    <script>
        Polymer({
            is: 'my-tokensform',
            properties: {
                params_need: {
                    type: String,
                    value: ""
                },
                value_param: {
                    type: String,
                    value: ""
                },
                prop_comp: {
                    type: String,
                    value: ""
                },
                prop_object: {
                    type: Object,
                    value: function () { return {} }
                },
                getName: {
                    type: String
                },
                visible: {
                    type: Boolean,
                    value: false
                },
                visible_text: {
                    type: Boolean,
                    value: true
                },
                change: {
                    type: Boolean,
                    value: false
                },
                loading: {
                    type: Boolean,
                    value: false,
                    reflectToAttribute: true
                },
                rol: {
                    type: String
                }
            },
            _getParams: function (getName, prop_object) {
                return { nameComp: getName, attr: prop_object };
            },
            _showproperties: function (name, data) {
                this.visible_text = false;
                this.visible = true;
                this.set('getName', data.name);
                var attributes = data.data[0].attributes;
                this.getAttr = Object.keys(attributes).map(function (key) {
                    return {
                        name: key,
                        value: attributes[key]
                    }
                });
                //borrar inputs del "formulario"
                this.querySelectorAll('#input-container input').forEach(function (el) { el.value = null })
            },
            _cleanObjectAttr: function () {
                this.set('prop_object', {});
            },
            _sendForm: function (evt) {
                //Habra que hacer que se muestre la calidad (entre los {} habra que meter los datos necesarios)
                this.fire("my-form-click", {});
            },
            _newChanges: function (evt) {
                var item = evt.model.item;
                var text = evt.currentTarget.value;
                //asi solo se mandan los atributos que correspondan con el componente que queremos analizar
                if (text === "") {
                    var name_prop = item.name;
                    delete this.prop_object[name_prop];
                } else {
                    this.set('prop_object.' + item.name, text);
                }
            },
            _analize: function (evt) {
                // this.$.button_analyze.classList.add('disabled');
                this.fire('loading-metrics', {});
                this.set('prop_object.rol', this.rol);
                this.$.send_attr.generateRequest();
                this.set('prop_object', {});
            },
            handleResponse: function (evt) {
                this.loading = false;
                console.log(evt.detail.response);
                this.fire("response-metrics", { data: evt.detail.response });
            },
        });
    </script>
</dom-module>